{% extends 'base.html' %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header bg-white">
                <h5 class="mb-0">Create New Short Link</h5>
            </div>
            <div class="card-body">
                <form method="post" id="urlForm">
                    {% csrf_token %}
                    
                    <!-- Main URL Input -->
                    <div class="mb-4">
                        <label for="original_url" class="form-label">Destination URL <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-link"></i></span>
                            <input type="url" class="form-control form-control-lg" id="original_url" name="original_url" 
                                   placeholder="https://example.com" required>
                        </div>
                        <div class="form-text">The long URL you want to shorten</div>
                    </div>
                    
                    <!-- Custom Short Code -->
                    <div class="mb-4">
                        <label for="short_code" class="form-label">Custom Short Code (optional)</label>
                        <div class="input-group">
                            <span class="input-group-text">{{ BASE_URL }}/</span>
                            <input type="text" class="form-control" id="short_code" name="short_code" 
                                   placeholder="my-custom-link" pattern="[A-Za-z0-9_-]+">
                        </div>
                        <div class="form-text">Leave blank to generate a random code. Only letters, numbers, hyphens, and underscores allowed.</div>
                    </div>
                    
                    <!-- Link Title -->
                    <div class="mb-4">
                        <label for="title" class="form-label">Title (optional)</label>
                        <input type="text" class="form-control" id="title" name="title" 
                               placeholder="My Awesome Link">
                        <div class="form-text">A descriptive name for your link</div>
                    </div>
                    
                    <!-- Advanced Options Toggle -->
                    <div class="mb-4">
                        <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" 
                                data-bs-target="#advancedOptions" aria-expanded="false" aria-controls="advancedOptions">
                            <i class="fas fa-cog me-1"></i> Advanced Options
                        </button>
                    </div>
                    
                    <!-- Advanced Options -->
                    <div class="collapse mb-4" id="advancedOptions">
                        <div class="card card-body bg-light">
                            <!-- Expiration Date -->
                            <div class="mb-3">
                                <label for="expires_at" class="form-label">Expiration Date</label>
                                <input type="date" class="form-control" id="expires_at" name="expires_at" 
                                       min="{{ today|date:'Y-m-d' }}">
                                <div class="form-text">Leave blank for no expiration</div>
                            </div>
                            
                            <!-- Password Protection -->
                            <div class="mb-3">
                                <div class="form-check form-switch mb-2">
                                    <input class="form-check-input" type="checkbox" id="password_protect" name="password_protect">
                                    <label class="form-check-label" for="password_protect">Password Protect</label>
                                </div>
                                <div id="passwordField" style="display: none;">
                                    <input type="password" class="form-control" id="password" name="password" 
                                           placeholder="Enter password">
                                    <div class="form-text">Visitors will need to enter this password to access the link</div>
                                </div>
                            </div>
                            
                            <!-- One-time Link -->
                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="is_one_time" name="is_one_time">
                                    <label class="form-check-label" for="is_one_time">One-time Link</label>
                                </div>
                                <div class="form-text">Link will be deactivated after first use</div>
                            </div>
                            
                            <!-- UTM Parameters -->
                            <div class="mb-3">
                                <label class="form-label">UTM Parameters (optional)</label>
                                <div class="row g-2 mb-2">
                                    <div class="col-md-6">
                                        <div class="input-group input-group-sm">
                                            <span class="input-group-text">utm_source</span>
                                            <input type="text" class="form-control" name="utm_source" placeholder="e.g., newsletter">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="input-group input-group-sm">
                                            <span class="input-group-text">utm_medium</span>
                                            <input type="text" class="form-control" name="utm_medium" placeholder="e.g., email">
                                        </div>
                                    </div>
                                </div>
                                <div class="row g-2">
                                    <div class="col-md-6">
                                        <div class="input-group input-group-sm">
                                            <span class="input-group-text">utm_campaign</span>
                                            <input type="text" class="form-control" name="utm_campaign" placeholder="e.g., summer_sale">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="input-group input-group-sm">
                                            <span class="input-group-text">utm_term</span>
                                            <input type="text" class="form-control" name="utm_term" placeholder="e.g., running+shoes">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{% url 'shortener:dashboard' %}" class="btn btn-outline-secondary me-md-2">Cancel</a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-link me-1"></i> Create Short Link
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Preview Card (initially hidden) -->
        <div class="card mt-4 d-none" id="previewCard">
            <div class="card-header bg-white">
                <h5 class="mb-0">Your Short Link</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Short URL</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="shortUrl" readonly>
                        <button class="btn btn-outline-secondary copy-btn" type="button" data-clipboard-target="#shortUrl">
                            <i class="far fa-copy"></i> Copy
                        </button>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">QR Code</label>
                    <div class="text-center">
                        <div id="qrcode" class="mb-2"></div>
                        <a href="#" id="downloadQr" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-download me-1"></i> Download
                        </a>
                    </div>
                </div>
                
                <div class="d-flex justify-content-between">
                    <a href="#" class="btn btn-sm btn-outline-secondary" id="editLink">
                        <i class="fas fa-edit me-1"></i> Edit
                    </a>
                    <a href="#" class="btn btn-sm btn-outline-primary" id="createAnother">
                        <i class="fas fa-plus me-1"></i> Create Another
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Toggle password field
        const passwordProtect = document.getElementById('password_protect');
        const passwordField = document.getElementById('passwordField');
        
        if (passwordProtect && passwordField) {
            passwordProtect.addEventListener('change', function() {
                passwordField.style.display = this.checked ? 'block' : 'none';
                if (!this.checked) {
                    document.getElementById('password').value = '';
                }
            });
        }
        
        // Form submission with AJAX
        const urlForm = document.getElementById('urlForm');
        const previewCard = document.getElementById('previewCard');
        
        if (urlForm) {
            urlForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Show loading state
                const submitBtn = this.querySelector('button[type="submit"]');
                const originalBtnText = submitBtn.innerHTML;
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Creating...';
                
                // Submit form data via AJAX
                const formData = new FormData(this);
                
                fetch(this.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                    credentials: 'same-origin',
                })
                .then(response => {
    if (!response.ok) {
        throw new Error('Network response was not ok');
    }
    return response.text().then(text => {
        try {
            return JSON.parse(text);
        } catch (e) {
            console.error('Response was not JSON:', text);
            throw new Error('Invalid JSON response');
        }
    });
})
                .then(data => {
                    if (data.success) {
                        // Show success message
                        showAlert('success', 'Short link created successfully!');
                        
                        // Update preview card
                        document.getElementById('shortUrl').value = data.short_url;
                        
                        // Generate QR code
                        generateQRCode(data.short_url);
                        
                        // Show preview card
                        previewCard.classList.remove('d-none');
                        
                        // Scroll to preview
                        previewCard.scrollIntoView({ behavior: 'smooth' });
                        
                        // Update form for creating another link
                        urlForm.reset();
                        urlForm.dataset.editMode = 'false';
                        
                        // Update download link
                        document.getElementById('downloadQr').setAttribute('download', `qrcode-${data.short_code}.png`);
                    } else {
                        // Show error message
                        showAlert('danger', data.message || 'An error occurred. Please try again.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('danger', 'An error occurred. Please try again.');
                })
                .finally(() => {
                    // Reset button state
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnText;
                });
            });
        }
        
        // Generate QR code
        function generateQRCode(url) {
            // In a real implementation, you would use a QR code library like qrcode.js
            // This is a simplified example
            const qrContainer = document.getElementById('qrcode');
            qrContainer.innerHTML = `<img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(url)}" alt="QR Code" class="img-fluid">`;
        }
        
        // Show alert message
        function showAlert(type, message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.role = 'alert';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            const container = document.querySelector('.container');
            container.insertBefore(alertDiv, container.firstChild);
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                const bsAlert = new bootstrap.Alert(alertDiv);
                bsAlert.close();
            }, 5000);
        }
        
        // Handle create another button
        const createAnotherBtn = document.getElementById('createAnother');
        if (createAnotherBtn) {
            createAnotherBtn.addEventListener('click', function(e) {
                e.preventDefault();
                previewCard.classList.add('d-none');
                urlForm.scrollIntoView({ behavior: 'smooth' });
            });
        }
        
        // Handle edit link button
        const editLinkBtn = document.getElementById('editLink');
        if (editLinkBtn) {
            editLinkBtn.addEventListener('click', function(e) {
                e.preventDefault();
                previewCard.classList.add('d-none');
                urlForm.scrollIntoView({ behavior: 'smooth' });
                
                // In a real implementation, you would populate the form with the existing data
                // and change the form action to update instead of create
                urlForm.dataset.editMode = 'true';
                urlForm.querySelector('button[type="submit"]').innerHTML = '<i class="fas fa-save me-1"></i> Update Link';
            });
        }
    });
</script>
{% endblock %}
